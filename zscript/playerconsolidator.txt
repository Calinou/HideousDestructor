// ------------------------------------------------------------
// The cause of - and solution to -
// ------------------------------------------------------------
extend class HDPlayerPawn{
	void ConsolidateAmmo(){
		let bp=HDBP(findinventory("HDBP"));

		//call all the Consolidates on actors
		//really everything below could be migrated to their own actors eventually
		for(inventory ppp=inv;ppp!=null;ppp=ppp.inv){
			let hdp=hdpickup(ppp);
			if(hdp)hdp.consolidate();
			let hdw=hdweapon(ppp);
			if(hdw)hdw.consolidate();
		}

		//reload as much brass as possible and consolidate again
		if(
			(countinv("LiberatorRifle")||countinv("BossRifle"))
		){
			int totalbrass=countinv("SevenMilBrass");
			int totalpowder=countinv("FourMilAmmo");

			//take recyclables out of guns
			let boss=bossrifle(findinventory("BossRifle"));
			if(boss){
				int br=boss.weaponstatus[BOSSS_CHAMBER];
				if(br!=2&&br!=4&&br>0){  
					totalbrass++;
					boss.weaponstatus[BOSSS_CHAMBER]=0;
				}
			}
			let libb=liberatorrifle(findinventory("LiberatorRifle"));
			if(libb){
				if(libb.weaponstatus[LIBS_CHAMBER]==1){
					libb.weaponstatus[LIBS_CHAMBER]=0;
					totalbrass++;
				}
				int brasss=libb.weaponstatus[LIBS_BRASS];
				libb.weaponstatus[LIBS_BRASS]=0;
				if(brasss>0)totalbrass+=brasss;  
			}
			let zed=zm66assaultrifle(findinventory("zm66assaultrifle"));
			if(
				zed&&
				zed.weaponstatus[0]
				&ZM66F_CHAMBERBROKEN
			){
				zed.weaponstatus[0]&=~(ZM66F_CHAMBER|ZM66F_CHAMBERBROKEN);
				totalpowder++;
			}

			//and other containers
			int brassinbp=0;
			int zedinbp=0;
			if(bp){
				brassinbp=bp.itemamount[bp.brassindex];
				zedinbp=bp.itemamount[bp.loosezedindex];

				totalbrass+=brassinbp;
				totalpowder+=zedinbp;
			}


			//figure out what you can actually do
			int max7=hdmath.maxinv(self,"SevenMilAmmo")-countinv("SevenMilAmmo");
			int max7bp=0;
			if(bp)max7bp=max(0,(HDBPC_CAPACITY-bp.getbulk())/(bp.itembulk[bp.sevenmilindex]));

			//random losses
			int scrapped=totalbrass*0.02+random(0,2);
			totalbrass-=scrapped;
			scrapped=totalpowder*0.05+random(0,12);
			totalpowder-=scrapped;

			//and now make the dang things
			int made=min(
				totalbrass,
				totalpowder/3,
				max7+max7bp
			);
			if(made>0){
				totalbrass-=made;
				totalpowder-=made*3;

				string loadedsevensmsg=string.format("Reloaded %i 7.76mm rounds during downtime.",made);

				//load Liberator mags to make room
				let llbbmm=HD7mMag(findinventory("HD7mMag"));
				bool sevensmagged=false;
				if(llbbmm){
					int llbbmmamt=llbbmm.mags.size();
					for(int i=0;i<llbbmmamt;i++){
						int intomag=min(
							30-llbbmm.mags[i],
							made
						);
						if(intomag>0){
							sevensmagged=true;
							llbbmm.mags[i]+=intomag;
							made-=intomag;
							if(made<1)break;
						}
					}
				}
				if(sevensmagged)loadedsevensmsg.appendformat(" Some were loaded into your Liberator mags.");
				A_Log(loadedsevensmsg,true);

				//fill inventory first, then backpack
				//let the player load into mags after
				max7=min(max7,made);
				made-=max7;
				A_GiveInventory("SevenMilAmmo",max7);

				//put stuff back into backpack
				if(bp){
					bp.itemamount[bp.sevenmilindex]+=made;
	
					brassinbp=min(totalbrass,brassinbp);
					zedinbp=min(totalpowder,zedinbp);
					totalbrass-=brassinbp;
					totalpowder-=zedinbp;
	
					bp.itemamount[bp.brassindex]=brassinbp;
					bp.itemamount[bp.loosezedindex]=zedinbp;
				}

				//put stuff back into inventory
				A_SetInventory("SevenMilBrass",totalbrass);
				A_SetInventory("FourMilAmmo",totalpowder);
			}
		}
	}
}



extend class HDBackpack{
	//go through all backpacked items and call their respective Consolidate()s
	override void Consolidate(){
		for(int i=0;i<invclasses.size();i++){
			if(havenone(i))continue;
			let type=(class<hdpickup>)(invclasses[i]);
			if(!type)continue;
			int onperson=BPToInv(owner,type);
			let thisinv=hdpickup(owner.findinventory(type));

			thisinv.Consolidate();

			//then put everything back
			int inbackpack=thisinv.amount-onperson;
			if(type is "HDMagAmmo"){
				let thismags=hdmagammo(thisinv);
				string ibp="";
				for(int i=0;i<inbackpack;i++){
					ibp=ibp..(ibp==""?"":" ")..thismags.mags[0];
					thismags.mags.delete(0);
					thismags.amount--;
				}
				amounts[i]=ibp;
			}else{
				amounts[i]=""..inbackpack;
				thisinv.amount=onperson;
			}

			thisinv.maxamount=getdefaultbytype(type).maxamount;
		}
	}

	//increase maxamount by backpackamount
	//take backpack contents and put them in inventory
	//return original amount on person
	static int BPToInv(actor caller,class<inventory> type){
		int originalamount=caller.countinv(type);
		let bp=hdbackpack(caller.findinventory("hdbackpack"));
		if(
			bp
			&&bp.invclasses.find(type.getclassname())>=0
		){
			int bpindex=bp.invclasses.find(type.getclassname());
			string addamt=bp.amounts[bpindex];
			if(addamt!=""){
				if(type is "HDMagAmmo"){
					array<string> bpmags;bpmags.clear();
					addamt.split(bpmags," ");
					hdmagammo onp=hdmagammo(caller.findinventory(type));
					for(int i=0;i<bpmags.size();i++){
						caller.A_GiveInventory(type,1);
						if(!onp)onp=hdmagammo(caller.findinventory(type));
						onp.maxamount=max(onp.maxamount,originalamount+bpmags.size());
						onp.mags.push(bpmags[i].toint());
					}
				}else if(type is "HDPickup"&&addamt.toint()>0){
					int bpamt=addamt.toint();
					caller.A_GiveInventory(type,bpamt);
					let cfi=caller.findinventory(type);
					cfi.maxamount=max(cfi.maxamount,originalamount+bpamt);
				}
			}
			bp.amounts[bpindex]="";
		}
		return originalamount;
	}
}
